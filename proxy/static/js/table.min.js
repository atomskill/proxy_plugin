"use strict";class Table{constructor(options){options=(typeof(options)==="object")?options:{};this.element=options.element;this.data=options.data;this.headers=options.headers;this.height=options.height;this.className=options.className||"";this.theadClassName=options.theadClassName||"";this.espClassName=options.espClassName||"";this.undefined_headers=!!options.undefined_headers;this.empty=options.empty||"----";this.values_text="(values)";this.redraw_bind=options.redraw_bind;this.sticky=!!options.sticky;this.esp=!!options.esp;this.sort=!!options.sort;this.sort_direction=true;this.sort_index=undefined;this.index_by=options.index_by;this.indexed=false;this.selected=this._load_state()["selected"]||[];this.limit=options.limit;this.range={start:0,end:this.data.length>this.limit?this.limit:this.data.length};this.links={thead_table:null,tbody_table:null,extra_settings_panel:null,column_toggle:null,selected:null}
window.Table.push(this);}
is_display(key){if(!this.headers){return true;}
if(Array.isArray(this.headers)){return!(this.headers[key].display===false||!Object.keys(this.headers).hasOwnProperty(key));}
return this.headers[key].display!==false;}
view(){const table=this;const element=this.element;let oct=false;if(!element||element.nodeType!==Node.ELEMENT_NODE){console.error("Table container is not a HTMLElement.");return false;}
while(element.firstChild){element.removeChild(element.firstChild);}
if(!Array.isArray(this.data)){this.data=[this.data];}
let headers={};this.data.forEach(function(column){if(typeof(column)==="object"){for(let key in column){if(column.hasOwnProperty(key)&&!(key in headers)){headers[key]={};}}}else{headers[0]={name:table.values_text};oct=true;}});if(this.headers){if(Boolean(this.undefined_headers)){Object.assign(headers,this.headers);}else{headers=this.headers;}}
let first_data=this.data[0];let data_available=(first_data&&first_data.hasOwnProperty(this.index_by))||!this.data.length;if(!this.indexed&&this.index_by!==undefined&&data_available){let index=this.index_by;this.data.forEach(function(row){if(row[index]!==undefined){if(Array.isArray(row)){row.splice(0,0,row[index]);}else{row[0]=row[index];}}});let index_header={name:this._custom_checkbox("select_all",true),format:(x)=>this._custom_checkbox(x),width:40,system:true}
if(Array.isArray(this.headers)){this.headers.splice(0,0,index_header);}else{this.headers[0]=index_header;}
this.indexed=true;this.theadClassName+=" vanillajs-table-indexed";}
let local_headers=this._load_state()["headers"]||[];try{local_headers.forEach((x)=>headers[x.id].display=x.display);}catch{this._save_state();}
element.table=table;element.classList.add("vanillajs-table");if(this.esp||this.limit){let esp=this.extraSettingsPanel();this.links.extra_settings_panel=esp;element.appendChild(esp);}
let thead_table=document.createElement("table");let thead=document.createElement("thead");let tr=thead.appendChild(document.createElement("tr"));for(let key in headers){if(headers.hasOwnProperty(key)){let th=document.createElement("th");let name="name"in headers[key]?headers[key].name:key;if(typeof(name)==="function"){name=name();}
key=this._isNumeric(key)?parseFloat(key):key;if(table.sort){th.classList.add("sorting");if(table.sort_index===key){th.classList.add(table.sort_direction?"decrease":"increase");}}
if(name.nodeName){th.appendChild(name);}else{th.innerHTML=name;}
th.setAttribute("data-title",key);headers[key].text=th.textContent;if(table.sort){th.addEventListener("click",()=>table.sorting(key));}
if(this.is_display(key)){tr.appendChild(th);}}}
thead_table.appendChild(thead);thead.className=thead_table.className="vanillajs-table-header "+this.theadClassName;element.appendChild(thead_table);this.links.thead_table=thead_table;let style=document.createElement("style");let style_property=document.createTextNode(".vanillajs-table td { box-sizing: border-box; }");style.appendChild(style_property);document.head.appendChild(style);let tbody_table=document.createElement("table");tbody_table.className=this.className;let tbody=document.createElement("tbody");let thead_clone=thead.cloneNode(true);thead_clone.style.visibility="collapse";tbody_table.appendChild(thead_clone);const range_data=this.data.slice(this.range.start,this.range.end);range_data.forEach(function(row){let tr=tbody.appendChild(document.createElement("tr"));let td=undefined;for(let header in headers){if(!headers.hasOwnProperty(header)||!table.is_display(header)){continue;}
let value=this.empty;let property=headers[header];if(typeof(row)==="object"){if(![undefined,null].includes(row[header])){if("format"in property&&typeof(property.format)==="function"){value=property.format(row[header],row);}else{value=[undefined,null].includes(row[header])?value:row[header];}}}else if(oct){value=row;}
td=tr.appendChild(document.createElement("td"));value=(value===undefined)?this.empty:value;if(typeof(value)==="object"&&!Array.isArray(value)){td.appendChild(value);}else{td.innerHTML=value;}
td.setAttribute("data-title",headers[header].text);if(property.className){td.className=property.className;}}},this);if(!this.data.length){let tr=document.createElement("tr");let td=document.createElement("td");td.textContent="no data available in table";td.style.textAlign="center";td.colSpan=thead.firstChild.childNodes.length;tr.appendChild(td);tbody.appendChild(tr);}
let div=document.createElement("div");div.className="vanillajs-table-data";if(this.height){div.style.overflow="auto";}
if(this.height){const is_function=(typeof this.height==="function");let height=parseFloat(is_function?this.height():this.height);div.style.maxHeight=height+"px";}
tbody_table.appendChild(tbody);div.appendChild(tbody_table);element.appendChild(div);this.links.tbody_table=tbody_table;if(this.sticky){this._set_sticky();}
element.resize=this.resize;element.resize();if(this.redraw_bind&&typeof(this.redraw_bind)==="function"){this.redraw_bind(table);}}
extraSettingsPanel(){let start_index=this.data.length?this.range.start+1:0;let statistc_div=document.createElement("div");statistc_div.className="vanillajs-table-text";statistc_div.style.float="right";statistc_div.textContent=`showing ${start_index} to ${this.range.end} of ${this.data.length} entries`;let page_div=document.createElement("div");page_div.className="vanillajs-table-group";page_div.style.float="right";if(this.limit){let prev_button=document.createElement("button");prev_button.textContent="<";prev_button.onclick=()=>this._previous();prev_button.className="vanillajs-table-button";prev_button.style.marginLeft="1rem";page_div.appendChild(prev_button);let current_page=(this.range.start/this.limit)+1;let page=document.createElement("button");page.textContent=current_page.toString();page.className="vanillajs-table-text";page.style.minWidth="30px";page.style.cursor="pointer";page.onfocus=()=>this._context_menu({data:()=>this._get_pages().map((x)=>({id:x,text:`page ${x}`,checked:page.textContent===x.toString()})),bind:(pages)=>{let page_index;pages.forEach((x)=>{if(x.checked){page_index=parseInt(x.text)-1;}});this.range.start=page_index*this.limit;this.range.end=this.range.start+this.limit;this.range.end=this.range.end>this.data.length?this.data.length:this.range.end;this.view();},radio:true,link:page_div});page_div.appendChild(page);let next_button=document.createElement("button");next_button.textContent=">";next_button.onclick=()=>this._next();next_button.className="vanillajs-table-button";page_div.appendChild(next_button);}
let column_toggle_button=document.createElement("button");column_toggle_button.textContent="â˜°";column_toggle_button.onfocus=()=>this._context_menu({data:()=>this._get_headers().map((x)=>({id:x.id,text:x.text,checked:x.display})),bind:(active_checkbox_list)=>{active_checkbox_list.forEach((x)=>{this.headers[x.text]["display"]=x.checked;});},link:this.links.column_toggle});column_toggle_button.className="vanillajs-table-button";let column_toggle_div=document.createElement("div");column_toggle_div.className="vanillajs-table-group";this.links.column_toggle=column_toggle_div;column_toggle_div.appendChild(column_toggle_button);let selected_button=document.createElement("div");selected_button.textContent=`${this.selected.length} selected`;selected_button.style.display=this.selected.length?"block":"none";selected_button.tabIndex=1;selected_button.onfocus=()=>this._context_menu({data:()=>this.selected.map((x)=>({id:x,text:x,checked:true})),bind:(active_checkbox_list)=>{this.selected=[];active_checkbox_list.forEach((x)=>{if(x.checked){this.selected.push(x.text);}});},link:this.links.selected});selected_button.className="vanillajs-table-link";let selected_div=document.createElement("div");selected_div.className="vanillajs-table-group";selected_div.style.marginLeft="1rem";this.links.selected=selected_div;selected_div.appendChild(selected_button);let div=document.createElement("div");div.className="vanillajs-table-extra-settings-panel "+this.espClassName;div.append(column_toggle_div);div.append(selected_div);div.append(page_div);div.appendChild(statistc_div);return div;}
_previous(){if(!this.limit){return false;}
this.range.start=(this.range.start>this.limit)?(this.range.start-this.limit):0;this.range.end=this.range.start+this.limit;this.range.end=this.range.end>this.data.length?this.data.length:this.range.end;this.view();return true;}
_next(){if(!this.limit||(this.range.start+this.limit)>=this.data.length){return false;}
this.range.start+=this.limit;this.range.start=this.range.start>this.data.length?this.data.length-1:this.range.start;this.range.end=this.range.start+this.limit;this.range.end=this.range.end>this.data.length?this.data.length:this.range.end;this.view();return true;}
_get_pages(){let pages=[];for(let i=0;i<this.data.length/this.limit;i++){pages.push(i+1);}
return pages;}
_get_headers(){let header_list=[];if(Array.isArray(this.headers)){this.headers.forEach(function(header,id){if(header.system){return false;}
header_list.push({display:header.hasOwnProperty("display")?header.display:true,text:header.text,id:id});});}else{Object.entries(this.headers).forEach(function(header){let[id,params]=header;if(params.system){return false;}
header_list.push({display:params.hasOwnProperty("display")?params.display:true,text:params.hasOwnProperty("text")?params.text:id,id:id});});}
return header_list;}
_context_menu(options){let div=document.createElement("div");let inner_div=document.createElement("div");options.data().sort().forEach(function(unit){let form_check=document.createElement("div");const uuid=String(Math.random());let checkbox=document.createElement("input");checkbox.type=options.radio?"radio":"checkbox";checkbox.checked=unit.checked;checkbox.value=unit.id;checkbox.id=uuid;checkbox.name="_context_menu_item";checkbox.className="form-check-input";let label=document.createElement("label");label.textContent=unit.text;label.htmlFor=uuid;form_check.appendChild(checkbox);form_check.appendChild(label);inner_div.appendChild(form_check);});inner_div.style.maxHeight="200px";inner_div.style.overflow="auto";div.appendChild(inner_div);let button=document.createElement("button");button.textContent="save";button.className="vanillajs-table-button";button.style.marginTop="10px";button.style.width="100%";button.onclick=()=>{let list=div.getElementsByTagName("input");let active_checkbox_list=[];for(let i=0;i<list.length;i++){active_checkbox_list.push({text:list[i]["value"],checked:list[i].checked});}
options.bind(active_checkbox_list);this._save_state();this.view();};div.appendChild(button);div.className="vanillajs-table-extra-list";div.tabIndex=-1;div.addEventListener("focusout",function(e){if(e.relatedTarget&&e.relatedTarget.offsetParent===div){e.target.focus();}else{div.remove();}});options.link.appendChild(div);if(div.getBoundingClientRect().right>window.innerWidth){div.style.right="0";}
div.focus();}
_save_state(){if(!this.element.id){console.warn("table.js: Can`t store table state. Element have not ID attribute.");return false;}
let key=`table.js::${location.pathname}::${this.element.id}`;localStorage.setItem(key,JSON.stringify({headers:this._get_headers(),selected:this.selected}));return true;}
_load_state(){if(!this.element.id){return false;}
let key=`table.js::${location.pathname}::${this.element.id}`;return JSON.parse(localStorage.getItem(key))||{};}
_custom_checkbox(value,check_all=false){let input=document.createElement("input");input.type="checkbox";input.className="form-check-input";input.value=value;input.checked=this.selected.indexOf(value)!==-1;if(check_all&&this.selected.length){input.indeterminate=true;}
input.addEventListener("click",(e)=>{const value=e.target.value;const is_checked=e.target.checked;if(is_checked){if(check_all){this.selected=[];this.data.forEach((x)=>this.selected.push(x[0]));this.view();}else{this.selected.push(value);}}else{if(check_all){this.selected=[];this.view();}else{this.selected.splice(this.selected.indexOf(value),1);}}
if(this.links.selected){this.links.selected.firstChild.innerText=`${this.selected.length} selected`;this.links.selected.firstChild.style.display=this.selected.length?"block":"none";}
this._save_state();});return input;}
_set_sticky(){let scroll_top=document.getElementsByTagName("html")[0].scrollTop;let esp=this.links.extra_settings_panel;if(esp){let esp_rect=esp.getBoundingClientRect();esp.style.position="sticky";esp.style.top=`${scroll_top + esp_rect.top}px`;}
let thead=this.links.thead_table;let thead_rect=thead.getBoundingClientRect();thead.style.position="sticky";thead.style.top=`${scroll_top + thead_rect.top}px`;}
sorting(index){if(this.indexed&&index===0){return false;}
this.sort_direction=(this.sort_index===index)?!this.sort_direction:false;this.sort_index=index;this.data=this._sorting(this.data,index,this.sort_direction);this.view();}
resize(){const table=this["table"];if(!table.links.tbody_table.rows.length){return false;}
const is_function=(typeof table.height==="function");let height=parseFloat(is_function?table.height():table.height);table.links.tbody_table.parentNode.style.maxHeight=height+"px";let headers=table.headers;let thead=table.links.thead_table.rows[0].childNodes;let tbody=table.links.tbody_table.rows[0].childNodes;table.links.thead_table.style.width="";for(let i=0;i<thead.length;i++){thead[i].style.width=tbody[i].style.width="";}
for(let i=0;i<thead.length;i++){let name=thead[i].getAttribute("data-title");let width=tbody[i].offsetWidth;if(name in headers&&"width"in headers[name]){let pre_width=headers[name].width;if(width/pre_width>0.2||pre_width==="auto"){width=pre_width;}}
tbody[i].style.width=(width==="auto")?width:width+"px";}
let tbody_width=table.links.tbody_table.offsetWidth;table.links.thead_table.style.width=tbody_width+"px";for(let i=0;i<thead.length;i++){thead[i].style.width=tbody[i].offsetWidth+"px";}}
_sorting(matrix,sort_index,sort_direction){const that=this;matrix.sort(function(a,b){let x,y;let direction=1;that._isNumeric(a[sort_index])?x=parseInt(a[sort_index]):x=a[sort_index];that._isNumeric(b[sort_index])?y=parseInt(b[sort_index]):y=b[sort_index];if(sort_direction)
direction=-1;if(x>y)
return direction;if(x<y)
return-direction;return 0;});return matrix;}
_isNumeric(x){let type=typeof(x);return(type==="number"||type==="string")&&!isNaN(x-parseFloat(x));}}
(function(){let timeisout=0;window.onresize=function(){clearTimeout(timeisout);timeisout=setTimeout(function(){let tables=document.getElementsByClassName("vanillajs-table");for(let i=0;i<tables.length;i++){tables[i].resize();}},200);}})();window.Table=[];document.getTableById=function(id){let target=NaN;let dom=document.getElementById(id);window.Table.forEach(function(table){if(table.element===dom){target=table;}});return target;};